import requests
from bs4 import BeautifulSoup
import json
from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi

# Підключення до MongoDB Atlas
uri = "mongodb+srv://dobryy_surfer:1Tsv3ry1mp0rtant!@surfer-cluster-2.erpms.mongodb.net/?retryWrites=true&w=majority&appName=Surfer-Cluster-2"
client = MongoClient(uri, server_api=ServerApi('1'))

try:
    client.admin.command('ping')
    print("Pinged your deployment. You successfully connected to MongoDB!")
except Exception as e:
    print("Помилка з'єднання з MongoDB:", e)
    exit()

# Вибір бази даних та колекції
db = client["books_db"]       # База даних (створиться автоматично, якщо її ще немає)
collection = db["books"]       # Колекція (також створиться автоматично)

# URL сторінки, яку будемо парсити
url = 'https://www.yakaboo.ua/ua/perelomnij-rik-365-dniv-schob-stati-ljudinoju-jakoju-vi-spravdi-hochete-buti.html'
response = requests.get(url)

if response.status_code == 200:
    response.encoding = 'utf-8'
    html_content = response.text
    soup = BeautifulSoup(html_content, 'html.parser')

    # Знаходимо всі блоки з характеристиками книги
    char_blocks = soup.find_all('div', class_='char')

    isbn = None
    author = None
    publisher = None
    year = None
    cover_url = None

    # Перебір блоків для вилучення даних
    for block in char_blocks:
        title_element = block.find('div', class_='char__title')
        if title_element:
            title_text = title_element.get_text(strip=True)
            value_element = block.find('div', class_='char__value')
            if value_element:
                value_text = value_element.get_text(strip=True)
                if 'ISBN' in title_text:
                    isbn = value_text
                elif 'Автор' in title_text:
                    author = value_text
                elif 'Видавництво' in title_text:
                    publisher = value_text
                elif 'Рік видання' in title_text:
                    year = value_text

    # Витягуємо URL обкладинки
    cover_div = soup.find('div', class_='slide__item')
    if cover_div:
        img = cover_div.find('img', class_='slide__img')
        if img:
            cover_url = img.get('src')

    # Формуємо словник з даними книги
    book_data = {
    'isbn': isbn if isbn else 'None',
    'author': author if author else 'None',
    'publisher': publisher if publisher else 'None',
    'year': year if year else 'None',
    'cover_url': cover_url if cover_url else 'None'
}

    # Вставляємо дані в MongoDB
    result = collection.insert_one(book_data)
    print("Документ вставлено з id:", result.inserted_id)

    # Додаємо _id до даних як рядок, якщо хочемо його зберегти
    book_data['_id'] = str(result.inserted_id)

    # Опційно: зберегти дані у JSON-файл для локального збереження
    with open('books_data.json', 'w', encoding='utf-8') as json_file:
        json.dump([book_data], json_file, ensure_ascii=False, indent=4)
    print("Дані збережено в books_data.json")

else:
    print("Помилка завантаження сторінки:", response.status_code)
